// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String    @id @default(cuid())
  did               String?   @unique // did:key 去中心化身份
  secondmeUserId    String    @unique @map("secondme_user_id")
  email             String?
  name              String?
  avatarUrl         String?   @map("avatar_url")
  accessToken       String    @map("access_token")
  refreshToken      String    @map("refresh_token")
  tokenExpiresAt    DateTime  @map("token_expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  sessions          Session[]
  notes             Note[]
  commitments       Commitment[] @relation("Promises")
  receivedCommitments Commitment[] @relation("Receives")
  givenAttestations  Attestation[] @relation("AttestationGiver") // 发出的证明
  receivedAttestations Attestation[] @relation("AttestationReceiver") // 收到的证明

  @@map("users")
}

model Session {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  sessionId    String    @unique @map("session_id")
  title        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Note {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  noteId       Int?      @map("note_id")
  content      String
  createdAt    DateTime  @default(now()) @map("created_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notes")
}

// VCA 可验证承诺证明模型
model Commitment {
  id            String    @id @default(cuid())
  promiserId    String    @map("promiser_id")   // 承诺者用户ID
  receiverId    String?   @map("receiver_id")   // 接收者用户ID（可选）
  context       String    // 上下文标签，如 "towow"
  task          String    // 任务描述
  deadline      DateTime? // 截止时间
  status        String   @default("PENDING") // PENDING, FULFILLED, FAILED, CANCELLED
  evidence      String?   // 履约证据链接
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // ToWow 集成字段
  source        String    @default("manual") @map("source") // manual, towow
  towowTaskId   String?   @map("towow_task_id")  // ToWow 任务 ID
  rewardAmount  Float?    @map("reward_amount")  // 报酬金额
  rewardCurrency String?  @map("reward_currency") // 货币类型 CNY/USD
  
  // VC 相关字段（可选，MVP阶段先不使用）
  vcId          String?   @unique // VC 的唯一标识
  vcJwt         String?   // VC 的 JWT 形式
  signedAt      DateTime? // 签名时间
  promiserDid   String?   // did:key
  receiverDid   String?   // did:key
  
  promiser      User      @relation("Promises", fields: [promiserId], references: [id])
  receiver      User?     @relation("Receives", fields: [receiverId], references: [id])
  attestations  Attestation[]
  
  @@index([promiserId, context])
  @@index([status])
  @@index([towowTaskId])
  @@map("commitments")
}

// CommitmentStatus 使用 String 代替 enum
// PENDING_ACCEPT - 待承诺方确认（委托方发起后）
// ACCEPTED       - 承诺方已接受，等待履约
// REJECTED       - 承诺方已拒绝
// PENDING        - 履约中（旧状态，兼容）
// FULFILLED      - 已完成（委托方验收通过）
// FAILED         - 失败（委托方验收不通过）
// CANCELLED      - 已取消

// 履约证明模型（替换原有的 Attestation）
model Attestation {
  id            String    @id @default(cuid())
  commitmentId  String    @map("commitment_id")
  attesterId    String    @map("attester_id")   // 证明者
  receiverId    String?   @map("receiver_id")   // 接收者证明
  fulfilled     Boolean  // 是否履约
  evidence      String?   // 证明证据
  comment       String?   // 备注
  
  // VC 相关字段
  vcId          String?   @unique
  vcJwt         String?
  signedAt      DateTime?
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  commitment    Commitment @relation(fields: [commitmentId], references: [id], onDelete: Cascade)
  attester      User       @relation("AttestationGiver", fields: [attesterId], references: [id])
  receiver      User?      @relation("AttestationReceiver", fields: [receiverId], references: [id])
  
  @@index([commitmentId])
  @@index([attesterId])
  @@map("attestations")
}

// 审计日志模型
model AuditLog {
  id          String   @id @default(cuid())
  action      String   // 操作类型：create_commitment, fulfill_commitment, create_attestation, update_reputation, etc.
  actorId     String   @map("actor_id")     // 操作者
  targetType  String   @map("target_type")  // 目标类型：commitment, attestation, user, reputation
  targetId    String   @map("target_id")    // 目标对象ID
  payload     String   // 操作详情（JSON格式字符串）
  timestamp   DateTime @default(now()) @map("timestamp")
  
  @@index([actorId])
  @@index([targetType, targetId])
  @@index([timestamp])
  @@map("audit_logs")
}
