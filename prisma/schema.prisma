// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  secondMeId    String?   @unique  // SecondMe user ID
  accessToken   String?   // SecondMe access token
  refreshToken  String?   // SecondMe refresh token
  apiKey        String?   @unique  // API key for ToWow integration
  accounts      Account[]
  sessions      Session[]
  agents        Agent[]   // Agents owned by this user
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Agent model for ToWow integration
model Agent {
  id              String    @id @default(cuid())
  did             String    @unique  // Decentralized ID (did:key)
  name            String
  description     String?
  ownerId         String    // User ID (SecondMe user)
  owner           User      @relation(fields: [ownerId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  issuedCommitments  Commitment[] @relation(name: "FromAgent")
  receivedCommitments Commitment[] @relation(name: "ToAgent")
}

// Commitment: a promise/obligation between agents
model Commitment {
  id            String    @id @default(cuid())
  fromAgentId   String
  fromAgent     Agent     @relation(name: "FromAgent", fields: [fromAgentId], references: [id])
  toAgentId     String
  toAgent       Agent     @relation(name: "ToAgent", fields: [toAgentId], references: [id])
  context       String    // e.g., "towow-task"
  task          String    // Description of the commitment
  deadline      DateTime?
  status        CommitmentStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  attestations  Attestation[]
}

// Attestation: proof of fulfillment (or non-fulfillment)
model Attestation {
  id            String    @id @default(cuid())
  commitmentId  String
  commitment    Commitment @relation(fields: [commitmentId], references: [id])
  fulfilled     Boolean
  evidence      String?   // URL or IPFS hash
  metadata      Json?     // Additional data (rating, notes, etc.)
  signedBy      String    // SecondMe user ID who signed
  signature     String    // Digital signature (optional)
  createdAt     DateTime  @default(now())
}

// Reputation cache (materialized view alternative)
// Updated when new attestations are added
model Reputation {
  agentId       String
  context       String
  totalTasks    Int       @default(0)
  fulfilled     Int       @default(0)
  averageRating Float?
  lastUpdated   DateTime  @default(now())

  @@id([agentId, context])
}

enum CommitmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}